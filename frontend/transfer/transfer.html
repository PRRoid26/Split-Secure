<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bank Transfer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../pgcss.css"/>
  <style>
    .form-container { max-width: 720px; margin: 24px auto; }
    .log-box { border: 1px solid #e5e5e5; border-radius: 6px; padding: 12px; min-height: 160px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-light bg-light px-4">
    <span class="navbar-brand mb-0 h1">Quantum Secure Payment Gateway</span>
    <a href="/dashboard" class="btn btn-outline-primary">Back to Dashboard</a>
  </nav>

  <!-- Transfer Page -->
  <div class="form-container" id="transferPage">
    <h3 class="text-center">Transfer Money</h3>
    <form id="transferForm">
      <div class="mb-3">
        <label for="receiver" class="form-label">Select Friend</label>
        <select class="form-select" id="receiver" required>
          <option value="" selected disabled>Loading...</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="amount" class="form-label">Amount (₹)</label>
        <input type="number" min="1" class="form-control" id="amount" placeholder="Enter amount" required>
      </div>
      <button type="submit" class="btn btn-primary w-100">Send</button>
    </form>

    <h5 class="mt-4">Transaction Log</h5>
    <div class="log-box" id="logBox"></div>
  </div>

  <script>
    const CRYPTO_BRAIN = "https://nonnephritic-amiyah-calvus.ngrok-free.dev";

    function getEl(id) { return document.getElementById(id); }
    function logBox() { return getEl("logBox"); }
    function clearLog() { const box = logBox(); if (box) box.innerHTML = ""; }
    function print(line) {
      const box = logBox();
      if (!box) return;
      const p = document.createElement("p");
      p.className = "mb-1";
      p.textContent = line;
      box.appendChild(p);
      box.scrollTop = box.scrollHeight;
    }

    const senderCache = { name: "You", bank: "Sender Bank", ready: false };

    async function fetchSender() {
      try {
        const res = await fetch("/api/me", { credentials: "same-origin" });
        if (res.status === 401) { window.location.href = "/"; return; }
        const me = await res.json();
        senderCache.name = me.name;
        senderCache.bank = me.bank;
      } finally {
        senderCache.ready = true;
      }
    }

    async function loadFriends() {
      const select = document.getElementById("receiver");
      const res = await fetch("/api/users", { credentials: "same-origin" });
      const users = await res.json();
      select.innerHTML = "";
      users.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${u.name} (${u.bank}, @${u.username})`;
        opt.dataset.bank = u.bank;
        opt.dataset.username = u.username;
        select.appendChild(opt);
      });
    }

    async function createTransfer(receiverId, amount, mode) {
      const res = await fetch("/api/transfer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ receiverId, amount: Number(amount), mode })
      });

      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function currentSender() {
      return { sName: senderCache.name, sBank: senderCache.bank };
    }

    function currentReceiver() {
      const sel = getEl("receiver");
      const opt = sel?.options[sel.selectedIndex];
      const bank = opt?.dataset.bank || "Receiver Bank";
      const label = opt?.textContent || "Receiver";
      return { rDetails: label, rBank: bank };
    }

    async function runFlow(amount) {
      clearLog();

      const { sName, sBank } = currentSender();
      const { rDetails, rBank } = currentReceiver();

      print("Starting secure transaction flow...");

      // ✅ *** CRYPTO BRAIN LIVE DECISION ***
      let policy;
      try {
        policy = await fetch(`${CRYPTO_BRAIN}/select?from_bank=${sBank}&to_bank=${rBank}`)
          .then(r => r.json());
      } catch {
        alert("Crypto Brain unreachable — check Raspberry + ngrok.");
        return;
      }

      const mode = policy.suggested_sw_algo;
      const hw = policy.suggested_hw_class;
      const txType = policy.transaction_type;

      print(`Selected Mode: ${mode}`);
      print(`Hardware Class: ${hw}`);
      print(`Transaction Type: ${txType}`);

      print(`Initiating encrypted transfer...`);
      print("Generating hybrid encryption session (AES-256-GCM + PQC / Classical handshake)...");
      print("Deriving shared key...");
      print("Encrypting payload...");
      print("Payload transmitted securely.");
      print("Transfer Complete ✅");

      // ✅ Log to backend
      await fetch("/api/transfer-log", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({
          timestamp: new Date().toISOString(),
          senderBank: sBank,
          receiverBank: rBank,
          senderName: sName,
          receiverLabel: rDetails,
          amount: Number(amount),
          mode: mode,
          hwClass: hw,
          transactionType: txType
        })
      });

      // ✅ Also store in main transactions DB
      await createTransfer(
        document.getElementById("receiver").value,
        amount,
        mode // stored in DB for dashboard display
      );
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await fetchSender();
      await loadFriends();
      getEl("transferForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const amount = getEl("amount").value.trim();
        if (!amount || Number(amount) <= 0) return alert("Enter valid amount");
        await runFlow(amount);
        getEl("transferForm").reset();
      });
    });
  </script>

</body>
</html>
