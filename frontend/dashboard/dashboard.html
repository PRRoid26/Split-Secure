<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quantum Secure Payment Gateway</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../pgcss.css"/>
  <style>
    .dashboard-card { width: 80vw; max-width: 1400px; margin: 24px auto; min-height: 60vh; }
    .dashboard-card .card-body { padding: 2rem; font-size: 1.05rem; line-height: 1.6; }
    .dashboard-card h5 { font-size: 1.4rem; }
    .profile-list p { margin-bottom: .65rem; font-size: 1.1rem; }
    .profile-list strong { font-size: 1.05rem; }
    #editDetailsBtn.btn { padding: .6rem .9rem; font-size: 1rem; }
    .btn-success { padding: .75rem 1rem; font-size: 1.05rem; }
    .tx-scroll { max-height: 60vh; overflow-y: auto; }
    .tx-item { cursor: pointer; transition: transform .08s ease-in-out; }
    .tx-item:hover { transform: translateY(-2px); }
    .tx-item .card-body { padding: 1rem 1.1rem; }
    .tx-item .fw-semibold { font-size: 1.05rem; }
    .tx-item small { font-size: .95rem; }
    .navbar .navbar-brand { font-size: 1.25rem; }
    .navbar .btn { padding: .5rem .9rem; font-size: 1rem; }
    @media (max-width: 767.98px) {
      .dashboard-card { width: 94vw; min-height: auto; }
      .split-col { border-top: 1px solid #eee; margin-top: 16px; padding-top: 16px; }
      .profile-list p { font-size: 1.05rem; }
      .tx-item .fw-semibold { font-size: 1.02rem; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-light px-4">
    <span class="navbar-brand mb-0 h1">Quantum Secure Payment Gateway</span>
    <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
  </nav>

  <div class="card shadow dashboard-card">
    <div class="card-body">
      <div class="row">
        <!-- Left: User info -->
        <div class="col-md-5">
          <h5 class="mb-3">User Profile</h5>
          <div class="profile-list">
            <p><strong>Name:</strong> <span id="profileName"></span></p>
            <p><strong>Account No:</strong> <span id="profileAcct"></span></p>
            <p><strong>Username:</strong> <span id="profileUsername"></span></p>
            <p><strong>Phone:</strong> <span id="profilePhone"></span></p>
            <p><strong>Bank:</strong> <span id="profileBank"></span></p>
          </div>
          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-primary btn-sm" id="editDetailsBtn">Edit Details</button>
            <a class="btn btn-success" href="../transfer/transfer.html">Do Money Transfer</a>
          </div>
        </div>

        <!-- Right: Real-time transactions -->
        <div class="col-md-7 split-col">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Transaction Log</h5>
          </div>

          <div id="txContainer" class="tx-scroll"></div>

          <div class="text-end mt-2">
            <!-- Optional link to a full logs page -->
            <!-- <a class="btn btn-sm btn-outline-secondary" href="../logs.html">Open full logs</a> -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function logout() {
      try {
        await fetch("/logout", { method: "POST", credentials: "same-origin" });
        window.location.href = "/";
      } catch {
        window.location.href = "/";
      }
    }

    async function fetchMe() {
      const res = await fetch("/api/me", {
        method: "GET",
        credentials: "same-origin",
        headers: { Accept: "application/json" }
      });
      if (res.status === 401) { window.location.href = "/"; return null; }
      if (!res.ok) throw new Error("Failed to fetch profile");
      const data = await res.json();
      document.getElementById("profileName").textContent = data.name || "";
      document.getElementById("profileAcct").textContent = data.account || "";
      document.getElementById("profileUsername").textContent = data.username || "";
      document.getElementById("profilePhone").textContent = data.phone || "";
      document.getElementById("profileBank").textContent = data.bank || "";
      return data;
    }

    async function fetchTransactions() {
      const res = await fetch("/api/transactions", {
        method: "GET",
        credentials: "same-origin",
        headers: { Accept: "application/json" }
      });
      if (res.status === 401) { window.location.href = "/"; return []; }
      if (!res.ok) throw new Error("Failed to fetch transactions");
      return res.json();
    }

    function renderTxList(rows) {
      const c = document.getElementById("txContainer");
      c.innerHTML = "";
      if (!rows || rows.length === 0) {
        const p = document.createElement("p");
        p.className = "text-muted";
        p.textContent = "No transaction history.";
        c.appendChild(p);
        return;
      }
      rows.forEach(r => {
        const card = document.createElement("div");
        card.className = "card mb-2 tx-item";
        const incoming = r.direction === "IN";
        const title = incoming ? `Received from ${r.senderName}` : `Paid to ${r.receiverName}`;
        const amt = (incoming ? "+ " : "- ") + "₹" + Number(Math.abs(r.amount)).toLocaleString("en-IN");
        const amtClass = incoming ? "text-success" : "text-danger";
        const dateStr = new Date(r.ts).toLocaleString();
        card.innerHTML = `
          <div class="card-body py-2 px-3 d-flex justify-content-between">
            <div>
              <div class="fw-semibold">${title}</div>
              <small class="text-muted">${dateStr} • ${r.channel}</small>
            </div>
            <div class="${amtClass} fw-semibold">${amt}</div>
          </div>`;
        c.appendChild(card);
      });
    }

    // Keep a local cache
    let txCache = [];

    function connectSSE() {
      const src = new EventSource("/api/tx/stream");
      src.addEventListener("tx", async () => {
        try {
          const rows = await fetchTransactions();
          txCache = rows;
          renderTxList(txCache);
        } catch (e) {
          console.error(e);
        }
      });
      src.addEventListener("ping", () => {});
      src.onerror = () => {
        try { src.close(); } catch {}
        setTimeout(connectSSE, 3000);
      };
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const me = await fetchMe();
        if (!me) return;
        txCache = await fetchTransactions();
        renderTxList(txCache);
        connectSSE();
      } catch (e) {
        console.error(e);
      }
    });
  </script>
</body>
</html>
